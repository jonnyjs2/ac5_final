<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Interactive Park Map</title>
    <!-- Load Leaflet CSS -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
        integrity="sha2016-ej3L+R0tI9Q+8W75t8l1W3tY2/s4l2+1E4L5r8M+S4Y="
        crossorigin=""/>
    
    <!-- Link to the external stylesheet -->
    <link rel="stylesheet" href="map.css">

    <!-- Load Tailwind CSS for modern styling (used for tooltip content) -->
    <script src="https://cdn.tailwindcss.com"></script>
</head>
<!-- Removed all inline classes (font-sans antialiased) for cleaner structure -->
<body>
    <header class="bg-white shadow-md p-3">
        <h1 class="text-xl font-bold">Interactive GeoJSON Map</h1>
    </header>

    <div id="container">
        <!-- The map div is now inside the container -->
        <div id="map"></div>
        
        <!-- Toggle button for the side panel -->
        <div id="toggle-panel">
            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-6 h-6">
                <path stroke-linecap="round" stroke-linejoin="round" d="M3.75 6.75h16.5M3.75 12h16.5m-16.5 5.25h16.5" />
            </svg>
        </div>

        <!-- Side panel for filters/info (initially visible) -->
        <div id="side-panel">
            <h2 class="text-lg font-semibold mb-4">Park & Neighborhood Info</h2>
            <p>Hover over a green area on the map to see the park name and size.</p>
            <p class="mt-4 text-sm text-gray-500">This panel is ready for future filters or detailed information about clicked features.</p>
            <!-- Mock data table to satisfy CSS table selectors -->
            <table class="mt-6">
                <thead>
                    <tr><th>Key</th><th>Value</th></tr>
                </thead>
                <tbody>
                    <tr><td>Feature Count</td><td id="feature-count">0</td></tr>
                </tbody>
            </table>
        </div>
    </div>


    <!-- Load Leaflet JavaScript -->
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"
        integrity="sha2016-ej3L+R0tI9Q+8W75t8l1W3tY2/s4l2+1E4L5r8M+S4Y="
        crossorigin=""></script>

    <!-- The main logic is in the standard script block -->
    <script>
        // Check for the special content path variable for GeoJSON files.
        const BASE_PATH = typeof __fs_content_fetch_url_base__ !== 'undefined' ? __fs_content_fetch_url_base__ : './';
        
        /**
         * Utility function to fetch and parse a GeoJSON file.
         */
        async function loadGeoJson(fileName) {
            const filePath = BASE_PATH + fileName;
            try {
                const response = await fetch(filePath);
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                return await response.json();
            } catch (error) {
                console.error(`Could not load GeoJSON file ${filePath}:`, error);
                // Return an empty FeatureCollection if loading fails
                return { type: "FeatureCollection", features: [] };
            }
        }

        /**
         * Initializes the map after all GeoJSON data has been loaded.
         */
        async function initMap() {
            // Load both files concurrently
            const [neighborhoodsData, parksData] = await Promise.all([
                loadGeoJson('neighborhoods.geojson'),
                loadGeoJson('parks.geojson')
            ]);
            
            // --- 1. INITIALIZE MAP ---
            // Set map to default view centered near Seattle
            const map = L.map('map').setView([47.6062, -122.3321], 12); 

            // Add a base tile layer (OpenStreetMap)
            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                maxZoom: 19,
                attribution: '&copy; <a href="http://www.openstreetmap.org/copyright">OpenStreetMap</a>'
            }).addTo(map);
            
            // Define the default style for all park features
            function parkStyle(feature) {
                return {
                    fillColor: '#38A169', // Primary park green
                    weight: 2,
                    opacity: 1,
                    color: 'white',
                    dashArray: '3',
                    fillOpacity: 0.7
                };
            }

            // --- 2. PARKS LAYER WITH HOVER FEATURE (Tooltip) ---
            let parksLayer;

            /**
             * Function executed for every single feature in the parks GeoJSON layer.
             * Sets up the interactive hover tooltip and styling.
             */
            function onEachParkFeature(feature, layer) {
                const name = feature.properties.NAME || 'Unnamed Green Space';
                // Assuming PARKSBND_AREA is in square feet, convert to acres
                const area = feature.properties.PARKSBND_AREA ? 
                            `${(feature.properties.PARKSBND_AREA / 43560).toFixed(2)} acres` : 
                            'Area Unknown';

                // Create the content for the hover tooltip using Tailwind classes
                const tooltipContent = `
                    <div class="park-tooltip-content">
                        <span class="text-lg text-green-700">${name}</span><br/>
                        <span class="text-sm text-gray-600">Area: ${area}</span>
                    </div>
                `;

                // Bind a permanent tooltip that is initially hidden by CSS opacity
                layer.bindTooltip(tooltipContent, {
                    permanent: true,     
                    direction: 'top',    
                    className: 'park-tooltip opacity-0 transition-opacity duration-200' 
                });

                // Add event listeners for hover interaction
                layer.on({
                    mouseover: (e) => {
                        // Show tooltip
                        e.target.getTooltip().getElement().style.opacity = '1';
                        // Highlight feature
                        e.target.setStyle({ fillColor: '#68D391', fillOpacity: 0.8 }); 
                    },
                    mouseout: (e) => {
                        // Hide tooltip
                        e.target.getTooltip().getElement().style.opacity = '0';
                        // Revert style
                        parksLayer.resetStyle(e.target);
                    },
                    click: (e) => {
                        // Example: Add a popup on click for more persistent info
                        L.popup()
                            .setLatLng(e.latlng)
                            .setContent(`<h3>${name}</h3><p>Area: ${area}</p>`)
                            .openOn(map);
                    }
                });
            }


            // Load the Parks GeoJSON Layer
            parksLayer = L.geoJSON(parksData, {
                style: parkStyle,
                onEachFeature: onEachParkFeature
            }).addTo(map);
            
            // Update feature count in side panel
            const featureCountElement = document.getElementById('feature-count');
            if (parksData.features && featureCountElement) {
                featureCountElement.textContent = parksData.features.length;
            }

            // Check if any features were successfully loaded before attempting to fit bounds
            if (parksData.features && parksData.features.length > 0) {
                 // Fit the map bounds to the parks layer so they are all visible
                map.fitBounds(parksLayer.getBounds());
            } else {
                console.warn("Parks data failed to load features. Setting default view.");
            }
           

            // --- 3. NEIGHBORHOODS LAYER ---
            
            if (neighborhoodsData.features && neighborhoodsData.features.length > 0) {
                 L.geoJSON(neighborhoodsData, {
                    style: function (feature) {
                        return {
                            fillColor: '#4A5568', // Dark grey for boundaries
                            weight: 1,
                            opacity: 0.5,
                            color: '#2D3748',
                            fillOpacity: 0.05 // Very light fill
                        };
                    }
                }).addTo(map);
            } else {
                console.warn("Neighborhoods data failed to load features.");
            }
        }

        // --- 4. SIDE PANEL TOGGLE LOGIC ---
        function setupPanelToggle() {
            const toggleButton = document.getElementById('toggle-panel');
            const sidePanel = document.getElementById('side-panel');

            if (toggleButton && sidePanel) {
                toggleButton.addEventListener('click', () => {
                    sidePanel.classList.toggle('collapsed');
                });
            }
        }

        // Start the map initialization and setup panel logic
        initMap();
        setupPanelToggle();
    </script>
</body>
</html>
